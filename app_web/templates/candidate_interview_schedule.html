        {% load static %}
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Schedule Interview</title>
        
                <link href="{% static 'lib/homePage/css/bootstrap.min.css' %}" rel="stylesheet">
                <link href="{% static 'lib/homePage/css/fontawesome-all.min.css' %}" rel="stylesheet">
            
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.min.css">
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>

            <style>
                body { font-family: 'Inter', sans-serif; }
                .slot-container { max-height: 400px; overflow-y: auto; scroll-behavior: smooth; padding-right: 1rem; }
                .time-slot { min-width: 100px; cursor: pointer; text-align: center; }
                .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
                .day-cell { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 500; border-radius: 50%; transition: all 0.2s; }
                .day-cell:not([disabled]):hover { background-color: var(--bs-light); }
                .day-selected { background-color: var(--bs-primary) !important; color: white !important; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.5); }
            </style>
        </head>
        <body class="bg-light min-vh-100 d-flex justify-content-center align-items-start py-4">
            {% if status == 'S' %}

        <div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
            <div class="card shadow-lg border-0 rounded-4 p-4 p-md-5 text-center" style="max-width: 600px; width: 100%;">
                <div class="mb-4">
                    <div class="mx-auto d-flex align-items-center justify-content-center bg-success-subtle rounded-circle" style="width: 100px; height: 100px;">
                        <i class="fas fa-calendar-check fa-4x text-success"></i>
                    </div>
                </div>
                <h1 class="fw-bold text-dark mb-3">Interview Scheduled</h1>
                <p class="text-secondary fs-5 mb-4">
                    You have already scheduled your interview for the <br>
                    <span class="fw-bold text-dark">{{ job_title }}</span> position at <span class="fw-bold text-dark">{{ company_name }}</span>.
                </p>
                <div class="alert alert-light border border-secondary-subtle rounded-3 text-start d-flex align-items-start p-3">
                    <i class="fas fa-envelope-open-text text-primary fs-4 me-3 mt-1"></i>
                    <div>
                        <h5 class="fw-bold text-dark fs-6 mb-1">Check your inbox</h5>
                        <p class="text-muted small mb-0">
                            We have sent a calendar invite with the Zoom link to your registered email address.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    {% else %}

            <div id="app" class="container-fluid px-0">
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden mx-auto" style="max-width: 1200px;">
                    <div class="d-flex flex-column flex-lg-row">
                        <div class="col-lg-4 bg-light p-4 p-sm-5 border-bottom border-lg-end border-lg-bottom-0 d-flex flex-column justify-content-between">
                            <div>
                                <div class="d-flex align-items-center mb-4">
                                    <i class="fas fa-calendar-check fa-2x text-primary me-2"></i>
                                    <span class="fs-4 fw-bold text-dark">{{ company_name }}</span>
                                </div>
                                <div class="mb-5">
                                    <h2 class="fs-3 fw-bolder text-dark mt-0">{{ job_title }}</h2>
                                </div>
                                <div class="space-y-3 text-secondary">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-clock fa-lg text-primary me-3"></i>
                                        <span class="fw-medium">30 min</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-video fa-lg text-primary me-3"></i>
                                        <span class="fw-medium">Online Interview</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8 p-4 p-sm-5">
                            <div id="confirmation-view" class="d-none d-flex align-items-center justify-content-center h-100"></div>
                            
                            <div id="scheduling-view">
                                <h2 class="fs-4 fw-bold text-dark mb-4">Select a Date & Time</h2>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div id="calendar-container" class="pb-3 border-bottom"></div>
                                        <div class="mt-4 pt-3 text-sm text-secondary d-flex align-items-center">
                                            <i class="fas fa-globe me-2 text-secondary"></i>
                                            Time zone: <span class="fw-medium ms-1">Indian Standard Time</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6 border-md-start ps-md-4">
                                        <p class="fs-5 fw-semibold text-dark mb-4" id="slots-header"></p>
                                        <div id="time-slots-container" class="slot-container d-flex flex-column gap-3"></div>
                                        <div class="mt-4 pt-4 border-top">
                                            <button id="confirm-button" disabled
                                                class="btn btn-primary w-100 py-3 fw-bold fs-5 shadow-sm transition-transform"
                                                style="transition: transform 0.2s;">
                                                Confirm Selection
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

         {% endif %}
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script>
            // **DEFINE THE MISSING CSRF TOKEN**
            const CSRF_TOKEN = "{{ csrf_token }}"; 
        </script>
        <script>
            const CONFIG = {
                'portal': '' 
            };
           function extractCandidateIdFromCurrentUrl() {
            // Get the current path (e.g., /candidate-schedule-interview/yqxNWI6cifM8iNOLExKzcg==/)
            const path = window.location.pathname; 
            const prefix = "/candidate-schedule-interview/";

            if (path.includes(prefix)) {
                // Split by the prefix and take the second part (the ID)
                let id = path.split(prefix)[1]; 
                
                // Remove trailing slash if it exists
                if (id && id.endsWith('/')) {
                    id = id.slice(0, -1);
                }
                
                return id;
            }
            return null;
        }

        // Example of how to use this function in the browser:
        const candidateID = extractCandidateIdFromCurrentUrl();

        if (candidateID !== null) {
            console.log(`Successfully extracted ID from the browser URL: ${candidateID}`);
            // You can now use this ID to make an API call, update the UI, etc.
            
            // --- Example of updating an element on the page ---
            const element = document.getElementById('candidate-id-display');
            if (element) {
                element.textContent = candidateID;
            }
            // ----------------------------------------------------

        } else {
            console.log("Could not find a valid candidate ID in the current URL.");
        }

            // --- ASSUMED Django Context Variables (Must be set in your Django View) ---
            const slots_available_api = {{ slots_available|safe }}; 
            // const candidate_id_api = "{{ candidate_id_from_url|safe }}"; // <-- Candidate ID from URL (e.g., '393')
            // -----------------------------------------------------------------------
            const candidate_id = candidateID

            let processedSlots = {};

            let state = {
                currentMonth: new Date(), 
                selectedDateKey: null, 
                selectedTime: null,
                isSubmitting: false,
                isConfirmed: false,
            };

            // --- 1. THE FIXED DATE PARSER (Storing the whole raw slot object for full context) ---
            function processApiSlots(slots) {
                const groupedSlots = {};
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

                slots.forEach(slot => {
                    // Manually parse ISO string to avoid Browser Timezone shifts
                    let [rawDate, rawTime] = slot.start_time.split('T'); 
                    
                    let timePart = rawTime.substring(0, 5); // "19:00"
                    let [hour, minute] = timePart.split(':');
                    
                    const dateKey = rawDate; // YYYY-MM-DD

                    // Create a date object JUST for getting the Day Name (Mon, Tue)
                    const dateObj = new Date(rawDate + 'T00:00:00'); 
                    const fullDate = `${dayNames[dateObj.getDay()]}, ${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}`;

                    // Format Time (19:00 -> 07:00 PM)
                    let hourInt = parseInt(hour);
                    const ampm = hourInt >= 12 ? 'PM' : 'AM';
                    hourInt = hourInt % 12;
                    hourInt = hourInt ? hourInt : 12; 
                    const timeString = `${hourInt}:${minute} ${ampm}`;

                    if (!groupedSlots[dateKey]) {
                        groupedSlots[dateKey] = {
                            fullDate: fullDate,
                            slots: [],
                            rawSlots: {} 
                        };
                    }
                    
                    groupedSlots[dateKey].slots.push(timeString);
                    
                    // Store the entire raw slot object for easy access later
                    groupedSlots[dateKey].rawSlots[timeString] = slot; 
                });

                // Sort time slots
                for (const dateKey in groupedSlots) {
                    groupedSlots[dateKey].slots.sort((a, b) => {
                        return new Date('1970/01/01 ' + a) - new Date('1970/01/01 ' + b);
                    });
                }

                return groupedSlots;
            }

            const formatDate = (date, format) => {
                if (format === 'key') { // YYYY-MM-DD
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                }
                if (format === 'full') { 
                    return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                }
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            };

            function renderCalendar() {
                const container = document.getElementById('calendar-container');
                if (!container) return;

                const startOfMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), 1);
                const endOfMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + 1, 0);
                const daysInMonth = endOfMonth.getDate();
                const startDayOfWeek = startOfMonth.getDay(); 

                const todayKey = formatDate(new Date(), 'key');
                
                let calendarHtml = `
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <button type="button" onclick="navigateMonth(-1)" class="btn btn-sm btn-outline-secondary rounded-circle">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 class="fs-6 fw-bold text-dark mb-0">${formatDate(state.currentMonth)}</h3>
                        <button type="button" onclick="navigateMonth(1)" class="btn btn-sm btn-outline-secondary rounded-circle">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid text-center text-secondary fw-semibold mb-2">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                            `<span class="text-uppercase">${day}</span>`
                        ).join('')}
                    </div>
                    <div class="calendar-grid text-center">
                `;

                for (let i = 0; i < startDayOfWeek; i++) {
                    calendarHtml += `<div class="day-cell"></div>`;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), day);
                    const dateKey = formatDate(date, 'key');
                    const isAvailable = processedSlots[dateKey];
                    const isSelected = dateKey === state.selectedDateKey;
                    const isToday = dateKey === todayKey;

                    let classes = `day-cell `;
                    let title = isAvailable ? `Available slots on ${formatDate(date, 'full')}` : 'No slots available';
                    
                    if (isAvailable) {
                        classes += ' text-dark btn-link p-0 ';
                    } else {
                        classes += ' text-muted ';
                    }

                    if (isSelected) {
                        classes += ' day-selected';
                    } else if (isToday) {
                        classes += ' border border-primary text-primary';
                    }

                    calendarHtml += `
                        <button type="button"
                            ${isAvailable ? `onclick="selectDate('${dateKey}')"` : 'disabled'}
                            class="${classes}"
                            title="${title}"
                        >
                            ${day}
                        </button>
                    `;
                }

                calendarHtml += `</div>`;
                container.innerHTML = calendarHtml;
            }

            function renderTimeSlots() {
                const slotsContainer = document.getElementById('time-slots-container');
                const header = document.getElementById('slots-header');
                const confirmBtn = document.getElementById('confirm-button');

                const activeDayData = processedSlots[state.selectedDateKey];
                if (!activeDayData) {
                    header.textContent = 'Please select an available date.';
                    slotsContainer.innerHTML = '<p class="text-muted fst-italic p-3 text-center w-100">No available time slots for the selected date.</p>';
                    confirmBtn.disabled = true;
                    return;
                }

                header.textContent = `Times for ${activeDayData.fullDate}`;

                let slotsHtml = activeDayData.slots.map(time => {
                    const isSelected = state.selectedTime === time;
                    let classes = `
                        time-slot btn shadow-sm border
                        ${isSelected ? 'btn-primary border-primary' : 'btn-light text-dark'}
                        ${state.isSubmitting ? 'opacity-75 disabled' : ''}
                    `;
                    
                    return `
                        <button type="button"
                            onclick="selectTime('${time}')"
                            ${state.isSubmitting ? 'disabled' : ''}
                            class="${classes}"
                        >
                            ${time}
                        </button>
                    `;
                }).join('');
                
                slotsContainer.innerHTML = slotsHtml;
                confirmBtn.disabled = !state.selectedTime || state.isSubmitting;
                confirmBtn.onclick = handleSubmit;
                
                confirmBtn.innerHTML = state.isSubmitting 
                    ? `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Booking...` 
                    : 'Confirm Selection';
            }

            function renderConfirmationView() {
                const schedulingView = document.getElementById('scheduling-view');
                const confirmationView = document.getElementById('confirmation-view');
                
                if (state.isConfirmed) {
                    const activeDayData = processedSlots[state.selectedDateKey];
                    confirmationView.innerHTML = `
                        <div class="card p-4 p-md-5 text-center border-top border-success border-5 shadow-sm">
                            <i class="fas fa-check-circle fa-4x text-success mx-auto mb-4 animate-pulse"></i>
                            <h1 class="fs-2 fw-bold text-dark mb-3">Interview Scheduled!</h1>
                            <p class="text-secondary mb-4">Your 30-minute block has been successfully booked.</p>
                            <div class="text-start bg-success-subtle p-3 rounded-3 border border-success-subtle">
                                <p class="d-flex align-items-center fw-semibold text-success mb-2">
                                    <i class="fas fa-calendar-alt me-3"></i>
                                    ${activeDayData.fullDate}
                                </p>
                                <p class="d-flex align-items-center fw-semibold text-success mb-0">
                                    <i class="fas fa-clock me-3"></i>
                                    ${state.selectedTime}
                                </p>
                            </div>
                           
                        </div>
                    `;
                    schedulingView.classList.add('d-none');
                    confirmationView.classList.remove('d-none');
                } else {
                    schedulingView.classList.remove('d-none');
                    confirmationView.classList.add('d-none');
                    confirmationView.innerHTML = '';
                }
            }

            // --- ACTION HANDLERS ---
            function navigateMonth(direction) {
                state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + direction, 1);
                updateUI();
            }

            function selectDate(dateKey) {
                state.selectedDateKey = dateKey;
                state.selectedTime = null; 
                updateUI();
            }

            function selectTime(time) {
                state.selectedTime = state.selectedTime === time ? null : time;
                renderTimeSlots(); 
            }

            function generateSlotId(dateKey, time, rawSlotData) {
    // 1. Reconstruct the date part (e.g., Fri-12-Dec-2025)
    const dateObj = new Date(dateKey + 'T00:00:00');
    // Ensure day/month names are capitalized for consistency, though short form is fine
    const dayNameShort = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
    const monthNameShort = dateObj.toLocaleDateString('en-US', { month: 'short' });
    const dayNum = String(dateObj.getDate()).padStart(2, '0'); // Pad day number for consistency
    const year = dateObj.getFullYear();
    
    // Example: Fri-12-Dec-2025
    const dateString = `${dayNameShort}-${dayNum}-${monthNameShort}-${year}`; 
    
    // 2. Reconstruct the time part (e.g., 03_00_PM) from the `time` variable ("03:00 PM")
    // Target format: HH_MM_AMPM (e.g., 03_00_PM)
    
    // Separate time and AM/PM: ["03:00", "PM"]
    const [timeOnly, ampm] = time.split(' ');
    
    // Replace colon with underscore: "03_00"
    const timeClean = timeOnly.replace(':', '_');
    
    // Combine: "03_00_PM"
    const timeStringClean = `${timeClean}_${ampm}`; 
    
    // 3. Get the unique suffix
    // Using the same logic as before, assuming 'available_interviewers' holds the ID
    const uniqueSuffix = rawSlotData.available_interviewers ? rawSlotData.available_interviewers[0] : '';
    
    // 4. Combine all parts with the double underscore separator
    const slotId = `${dateString}__${timeStringClean}__${uniqueSuffix}`;
    
    console.log("Generated Slot ID:", slotId); // Log for verification
    
    return slotId; 
}
            function handleSubmit() {
                if (!state.selectedTime || !state.selectedDateKey) return;
                
                state.isSubmitting = true;
                renderTimeSlots(); 

                const rawSlotData = processedSlots[state.selectedDateKey].rawSlots[state.selectedTime];

                // Generate the required 'slot_id' string
                const finalSlotId = generateSlotId(state.selectedDateKey, state.selectedTime, rawSlotData);

                // *** MODIFICATION: Update dataObj to match the required format ***
                let dataObj = {
                    "candidate_id": String(candidate_id), // Uses the assumed candidate_id from Django context
                    "slot_id": finalSlotId, 
                    "instructions": "",
                    "schedule_type": "N",
                };
                // *** END MODIFICATION ***

                let final_data = {
                    "data": JSON.stringify(dataObj),
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                };

                // Log the final payload for debugging
                console.log("Final Payload Data:", dataObj);
                
                const API_URL = CONFIG['portal'] + "/api/schedule-candidiate-interview";

               $.post(API_URL, final_data)
    .done(function (res) {
        console.log("API Response:", res); // Debugging

        // 1. CHECK SPECIFIC "SLOT TAKEN" ERROR
        if (res.data === "Please select another slot") {
            Swal.fire({
                title: "Error!",
                text: "Please Select another Slot.",
                icon: "error",
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.reload();
            });
        }
        
        // 2. SUCCESS CASE (Check both 'responseCode' and 'statusCode' to be safe)
        // Usually 0 means success
        else if (res.responseCode === 0 || res.statusCode === 0) {
            Swal.fire({
                icon: 'success',
                title: 'Scheduled!',
                text: 'Your interview slot has been successfully booked.',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                state.isSubmitting = false;
                state.isConfirmed = true;
                updateUI();
            });
        }

        // 3. ERROR CASE (statusCode is 1 or success is false)
        else {
            // Use the specific error message from the API if available
            let errorMsg = res.error || res.data || "Unknown error occurred";
            
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMsg, 
            }).then(() => {
                state.isSubmitting = false; // <--- THIS STOPS THE ROTATION
                updateUI(); 
            });
        }
    })
    .fail(function (err) {
        Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Could not connect to the server.',
        }).then(() => {
            state.isSubmitting = false; // <--- THIS STOPS THE ROTATION
            updateUI();
        });
    });
            }

            function resetState() {
                state.isConfirmed = false;
                state.selectedTime = null;
                updateUI();
            }

            function updateUI() {
                if (state.isConfirmed) {
                    renderConfirmationView();
                } else {
                    renderConfirmationView(); 
                    renderCalendar();
                    renderTimeSlots();
                }
            }

            // Export functions to window
            window.navigateMonth = navigateMonth;
            window.selectDate = selectDate;
            window.selectTime = selectTime;
            window.handleSubmit = handleSubmit;
            window.resetState = resetState;

            // --- MAIN INITIALIZATION (Merged) ---
            window.onload = () => {
                // 1. Debug Log
                console.log("Raw API Data:", slots_available_api); 
                

                // 2. Process Data
                if (slots_available_api && slots_available_api.length > 0) {
                    processedSlots = processApiSlots(slots_available_api);
                    
                    const firstAvailableKey = Object.keys(processedSlots)[0];
                    if (firstAvailableKey) {
                        state.selectedDateKey = firstAvailableKey;
                        const parts = firstAvailableKey.split('-').map(Number);
                        state.currentMonth = new Date(parts[0], parts[1] - 1, 1);
                    }
                } else {
                    processedSlots = {};
                }

                // 3. Render
                updateUI();
            };
        </script>
        </body>
        </html>